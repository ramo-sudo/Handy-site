<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Great Handyman • Quotes & Invoices</title>
  <style>
    /* Apple-ish: clean, light, lots of whitespace, big tap targets */
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:rgba(17,24,39,.10);
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --radius:18px;

      --blue:#007aff;      /* iOS-ish blue */
      --teal:#34c759;      /* iOS green */
      --orange:#ff9500;    /* iOS orange */
      --red:#ff3b30;       /* iOS red */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }

    /* Layout */
    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 14px 92px; /* bottom nav space */
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 12px 14px;
      background: rgba(243,244,246,.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 0 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(0,122,255,.95), rgba(52,199,89,.85));
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      flex:0 0 auto;
    }
    .brand .title{
      min-width:0;
      line-height:1.1;
    }
    .brand .title b{
      display:block;
      font-size:14px;
      letter-spacing:.2px;
    }
    .brand .title span{
      display:block;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 52vw;
    }

    /* UPDATED: two-line pill for doc number + full customer name */
    .doc-pill{
      flex:0 0 auto;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.8);
      padding: 8px 10px;
      border-radius: 14px;

      max-width: 56vw;
      white-space: normal;
      overflow: hidden;
    }
    #pillLine1{
      font-size:12px;
      color: var(--text);
      font-weight:600;
      line-height:1.15;
    }
    #pillLine2{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    @media (max-width: 420px){
      .doc-pill{ max-width: 48vw; }
      .brand .title span{ max-width: 44vw; }
    }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .stack{display:grid; gap:12px}
    .two{display:grid; gap:12px}
    @media (min-width: 860px){
      .two{grid-template-columns: 1fr 1fr}
    }

    .h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .h h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .sub{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }

    .divider{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    textarea{min-height: 90px; resize:vertical}
    input::placeholder, textarea::placeholder{color: rgba(107,114,128,.7)}

    .row{display:flex; gap:10px}
    .row > *{flex:1}

    /* Buttons */
    .btnbar{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .btn{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      min-height: 46px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      transition: transform .06s ease;
    }
    .btn:active{transform: scale(.99)}
    .btn.primary{
      background: rgba(0,122,255,.12);
      border-color: rgba(0,122,255,.28);
      color: #003b7a;
    }
    .btn.good{
      background: rgba(52,199,89,.12);
      border-color: rgba(52,199,89,.28);
      color: #0b4b1e;
    }
    .btn.warn{
      background: rgba(255,149,0,.12);
      border-color: rgba(255,149,0,.28);
      color: #7a3f00;
    }
    .btn.danger{
      background: rgba(255,59,48,.10);
      border-color: rgba(255,59,48,.25);
      color: #7a0b06;
    }
    .btn.ghost{
      background: #fff;
    }

    /* Segmented control */
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .seg button{
      flex:1;
      border:0;
      background: transparent;
      padding: 12px 10px;
      font-size: 13px;
      cursor:pointer;
      color: var(--muted);
      min-height: 44px;
    }
    .seg button.active{
      background: rgba(0,122,255,.10);
      color: #003b7a;
      font-weight: 600;
    }

    /* Small status chips */
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:12px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip.blue{border-color: rgba(0,122,255,.25); background: rgba(0,122,255,.08); color:#003b7a}
    .chip.green{border-color: rgba(52,199,89,.25); background: rgba(52,199,89,.08); color:#0b4b1e}
    .chip.red{border-color: rgba(255,59,48,.25); background: rgba(255,59,48,.06); color:#7a0b06}
    .chip.orange{border-color: rgba(255,149,0,.25); background: rgba(255,149,0,.08); color:#7a3f00}

    /* List rows */
    .list{display:grid; gap:10px}
    .listrow{
      border:1px solid var(--line);
      border-radius: 16px;
      background:#fff;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .meta{min-width:0}
    .meta b{display:block; font-size:14px}
    .meta span{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }

    /* Item cards */
    .item{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
    }
    .item-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .item-title{
      min-width:0;
    }
    .item-title b{
      display:block;
      font-size:14px;
      margin-bottom:3px;
    }
    .item-title span{
      display:block;
      font-size:12px;
      color: var(--muted);
    }
    .item-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .mini-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      min-height: 40px;
      cursor:pointer;
    }
    .mini-btn.danger{
      border-color: rgba(255,59,48,.25);
      background: rgba(255,59,48,.06);
      color:#7a0b06;
    }

    .kv{
      margin-top:10px;
      display:grid;
      gap:8px;
      font-size:12px;
      color: var(--muted);
    }
    .kv .line{display:flex; justify-content:space-between; gap:10px}
    .kv .line b{color: var(--text); font-weight:600}
    .kv .grand{
      border-top:1px solid var(--line);
      padding-top:10px;
      margin-top:4px;
      font-size:13px;
    }

    /* Bottom nav */
    .nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--line);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      z-index: 100;
    }
    .nav-inner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .navbtn{
      flex:1;
      border: 1px solid transparent;
      background: transparent;
      padding: 10px 8px;
      border-radius: 14px;
      cursor:pointer;
      min-height: 44px;
      color: var(--muted);
      font-size: 12px;
    }
    .navbtn.active{
      background: rgba(0,122,255,.10);
      border-color: rgba(0,122,255,.18);
      color: #003b7a;
      font-weight: 600;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 14px; right: 14px;
      bottom: 86px;
      max-width: 980px;
      margin: 0 auto;
      background: rgba(17,24,39,.92);
      color: #fff;
      border-radius: 16px;
      padding: 12px 14px;
      display:none;
      z-index: 999;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
    }
    .toast.show{display:block}
    .toast b{display:block; font-size:13px}
    .toast span{display:block; font-size:12px; opacity:.85; margin-top:2px; line-height:1.35}

    /* Print */
    @media print{
      body{background:#fff}
      .topbar,.nav,.noprint,.toast,.previewOverlay{display:none !important}
      .app{padding:0; max-width:none}
      #printArea{display:block !important}
      #printArea *{color:#000 !important}
    }
    #printArea{display:none}

    .doc{
      padding: 22px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }
    .doc .head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:20px;
      margin-bottom: 12px;
    }
    .doc .biz h1{margin:0 0 6px; font-size:20px}
    .doc .mut{color:#333; font-size:12px; line-height:1.35}
    .doc .box{
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 12px;
      min-width: 260px;
    }
    .doc .box b{display:block; margin-bottom:6px}
    .doc .kvp{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; line-height:1.5}
    .doc .twocol{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin: 10px 0 14px}
    .doc table{width:100%; border-collapse:collapse; font-size:12px}
    .doc th,.doc td{border-bottom:1px solid #ddd; padding:8px 6px; text-align:left; vertical-align:top}
    .doc th{border-top:1px solid #ddd; background:#f5f5f5}
    .doc td.r,.doc th.r{text-align:right}
    .doc .notes{
      margin-top: 14px;
      font-size:12px;
      border: 1px dashed #bbb;
      border-radius: 10px;
      padding: 10px 12px;
    }
    .doc .sectionTitle{font-weight:700; margin:0 0 6px}
    .doc .foot{
      margin-top: 12px;
      font-size:11px;
      color:#444;
      display:flex;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    /* UPDATED: Full-screen preview overlay (mobile-friendly) */
    .previewOverlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(243,244,246,.92);
      backdrop-filter: blur(14px);
      display: none;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .previewOverlay.show{ display:block; }
    .previewOverlay .panel{
      max-width: 980px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .previewOverlay .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .previewOverlay .bar b{ font-size:14px; }
    .previewOverlay .content{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border:1px solid var(--line);
      border-radius: 16px;
      background:#fff;
    }
    #screenPreview{ width:100%; }
  </style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar noprint">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <b>Great Handyman</b>
        <span id="topSubtitle">Quotes & Invoices • Offline</span>
      </div>
    </div>

    <!-- UPDATED: two-line pill -->
    <div class="doc-pill" id="docPill">
      <div id="pillLine1">No document</div>
      <div id="pillLine2"></div>
    </div>
  </div>
</div>

<div class="app">
  <!-- DOCS (Home) -->
  <section id="view-docs" class="stack noprint">
    <div class="card">
      <div class="h">
        <h2>Current Document</h2>
        <div class="chips" id="docChips"></div>
      </div>
      <div class="sub" id="docHint">Create a quote, add items, then convert to an invoice when ready.</div>

      <div class="two" style="margin-top:12px">
        <div>
          <label>Document type</label>
          <div class="seg" role="tablist" aria-label="Document type">
            <button id="segQuote" type="button">Quote</button>
            <button id="segInvoice" type="button">Invoice</button>
          </div>
        </div>
        <div>
          <label>Document number</label>
          <input id="docNumber" disabled />
        </div>
      </div>

      <div class="two">
        <div>
          <label>Issue date</label>
          <input id="issueDate" type="date" />
        </div>
        <div>
          <label id="date2Label">Valid until</label>
          <input id="date2" type="date" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="two">
        <div>
          <label>Customer</label>
          <select id="docCustomerSelect"></select>
          <div class="sub">Choose an existing customer or go to Customer tab to add one.</div>
        </div>

        <div>
          <label>Status</label>
          <div class="two" style="gap:10px">
            <div>
              <select id="sentState">
                <option value="0">Not sent</option>
                <option value="1">Sent</option>
              </select>
              <div class="sub" id="sentAtLine"></div>
            </div>
            <div id="paidWrap">
              <select id="paidState">
                <option value="0">Unpaid</option>
                <option value="1">Paid</option>
              </select>
              <div class="sub" id="paidAtLine"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="btnNewQuote" type="button">New Quote</button>
        <button class="btn ghost" id="btnSaveDoc" type="button">Save</button>
        <button class="btn warn" id="btnConvert" type="button">Convert to Invoice</button>
        <button class="btn danger" id="btnDeleteDoc" type="button">Delete</button>
      </div>
    </div>

    <div class="card">
      <div class="h">
        <h2>Totals</h2>
        <span class="sub">Customer-provided materials do not affect totals.</span>
      </div>
      <div class="kv" id="totalsBox"></div>
      <div class="btnbar">
        <button class="btn primary" id="btnGoItems" type="button">Add / Edit Items</button>
        <button class="btn" id="btnGoPreview" type="button">Preview</button>
      </div>
    </div>
  </section>

  <!-- CUSTOMER -->
  <section id="view-customer" class="stack noprint" style="display:none">
    <div class="card">
      <div class="h">
        <h2>Customer</h2>
        <span class="sub" id="custMode">New</span>
      </div>

      <label>Pick a customer</label>
      <select id="customerSelect"></select>

      <div class="two">
        <div>
          <label>Name</label>
          <input id="custName" placeholder="Customer name" />
        </div>
        <div>
          <label>Email</label>
          <input id="custEmail" placeholder="name@email.com" inputmode="email" />
        </div>
        <div>
          <label>Phone</label>
          <input id="custPhone" placeholder="(555) 555-5555" inputmode="tel" />
        </div>
        <div>
          <label>Service address</label>
          <input id="custAddress" placeholder="123 Main St, Phoenix, AZ" />
        </div>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="btnSaveCustomer" type="button">Save Customer</button>
        <button class="btn" id="btnNewCustomer" type="button">New</button>
        <button class="btn danger" id="btnDeleteCustomer" type="button">Delete</button>
      </div>
    </div>
  </section>

  <!-- ITEMS -->
  <section id="view-items" class="stack noprint" style="display:none">
    <div class="card">
      <div class="h">
        <h2>Items</h2>
        <span class="sub">Add labor, materials, or flat pricing — guided, minimal typing.</span>
      </div>

      <div class="stack" id="itemsList"></div>
    </div>

    <div class="card">
      <div class="h">
        <h2>Add Item</h2>
        <span class="sub">Step 1: choose a type.</span>
      </div>

      <!-- Step 1 -->
      <div class="seg" aria-label="Item type">
        <button id="segItemLabor" type="button">Labor</button>
        <button id="segItemMaterials" type="button">Materials</button>
        <button id="segItemFlat" type="button">Flat Price Bid</button>
      </div>

      <!-- Common -->
      <label>Description</label>
      <input id="addDesc" placeholder="e.g., Replace faucet" />

      <!-- Labor -->
      <div id="branchLabor" style="margin-top:8px">
        <div class="two">
          <div>
            <label>Hours</label>
            <select id="laborHours">
              <option value="0.5">0.5</option>
              <option value="1" selected>1</option>
              <option value="1.5">1.5</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="6">6</option>
              <option value="8">8</option>
            </select>
          </div>
          <div>
            <label>Hourly rate</label>
            <select id="laborRate">
              <option value="">Choose…</option>
              <option value="65">$65/hr</option>
              <option value="75">$75/hr</option>
              <option value="95">$95/hr</option>
              <option value="125">$125/hr</option>
              <option value="150">$150/hr</option>
              <option value="custom">Custom…</option>
            </select>
            <div id="laborRateCustomWrap" style="display:none; margin-top:8px">
              <input id="laborRateCustom" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Enter custom hourly rate" />
            </div>
          </div>
        </div>
      </div>

      <!-- Materials -->
      <div id="branchMaterials" style="display:none; margin-top:8px">
        <label>Materials source</label>
        <div class="seg" aria-label="Materials source">
          <button id="segMatBillable" type="button">Billable</button>
          <button id="segMatCustomer" type="button">Customer provided</button>
        </div>

        <div class="two">
          <div>
            <label>Quantity</label>
            <select id="matQty">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="custom">Custom…</option>
            </select>
            <div id="matQtyCustomWrap" style="display:none; margin-top:8px">
              <input id="matQtyCustom" type="number" min="0" step="1" inputmode="numeric" placeholder="Enter quantity" />
            </div>
          </div>
          <div>
            <label>Unit</label>
            <select id="matUnit">
              <option value="ea" selected>ea</option>
              <option value="box">box</option>
              <option value="ft">ft</option>
              <option value="set">set</option>
              <option value="custom">Custom…</option>
            </select>
            <div id="matUnitCustomWrap" style="display:none; margin-top:8px">
              <input id="matUnitCustom" placeholder="Enter unit (e.g., bag)" />
            </div>
          </div>
        </div>

        <!-- Billable only -->
        <div id="matBillableFields" class="two" style="margin-top:8px">
          <div>
            <label>Unit cost</label>
            <select id="matUnitCost">
              <option value="">Choose…</option>
              <option value="10">$10</option>
              <option value="25">$25</option>
              <option value="50">$50</option>
              <option value="100">$100</option>
              <option value="custom">Custom…</option>
            </select>
            <div id="matCostCustomWrap" style="display:none; margin-top:8px">
              <input id="matCostCustom" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Enter unit cost" />
            </div>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="sub">Customer-provided materials show on the document with no dollar value.</div>
          </div>
        </div>

        <div id="matCustomerNote" class="sub" style="display:none; margin-top:10px">
          Customer provided materials: this item will be listed with <b>no pricing</b> and excluded from totals.
        </div>
      </div>

      <!-- Flat -->
      <div id="branchFlat" style="display:none; margin-top:8px">
        <label>Amount</label>
        <select id="flatAmount">
          <option value="">Choose…</option>
          <option value="50">$50</option>
          <option value="100">$100</option>
          <option value="150">$150</option>
          <option value="250">$250</option>
          <option value="500">$500</option>
          <option value="custom">Custom…</option>
        </select>
        <div id="flatCustomWrap" style="display:none; margin-top:8px">
          <input id="flatCustom" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Enter flat amount" />
        </div>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="btnAddItem" type="button">Add Item</button>
        <button class="btn" id="btnClearAdd" type="button">Clear</button>
      </div>

      <div class="divider"></div>

      <div class="two">
        <div>
          <label>Tax rate (%)</label>
          <select id="taxRate">
            <option value="0" selected>0%</option>
            <option value="2">2%</option>
            <option value="4">4%</option>
            <option value="5.6">5.6%</option>
            <option value="8.6">8.6%</option>
            <option value="custom">Custom…</option>
          </select>
          <div id="taxCustomWrap" style="display:none; margin-top:8px">
            <input id="taxCustom" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Enter tax rate (%)" />
          </div>
        </div>
        <div>
          <label>Discount</label>
          <div class="two" style="gap:10px">
            <div>
              <select id="discountType">
                <option value="none" selected>None</option>
                <option value="percent">Percent</option>
                <option value="flat">Flat</option>
              </select>
            </div>
            <div>
              <select id="discountValuePreset">
                <option value="0" selected>0</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="custom">Custom…</option>
              </select>
              <div id="discountCustomWrap" style="display:none; margin-top:8px">
                <input id="discountCustom" type="number" min="0" step="0.01" inputmode="decimal" placeholder="Enter discount value" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button class="btn ghost" id="btnSavePricing" type="button">Save Pricing</button>
        <button class="btn" id="btnBackHome" type="button">Back to Document</button>
      </div>
    </div>
  </section>

  <!-- PREVIEW -->
  <section id="view-preview" class="stack noprint" style="display:none">
    <div class="card">
      <div class="h">
        <h2>Preview</h2>
        <span class="sub">Use Full Screen Preview to avoid zooming.</span>
      </div>

      <!-- UPDATED: Full Screen Preview button -->
      <div class="btnbar">
        <button class="btn primary" id="btnFullPreview" type="button">Full Screen Preview</button>
        <button class="btn" id="btnPrint" type="button">Print / Save PDF</button>
        <button class="btn" id="btnEmail" type="button">Email Draft</button>
        <button class="btn warn" id="btnConvert2" type="button">Convert to Invoice</button>
      </div>

      <div class="divider"></div>

      <label>Notes</label>
      <textarea id="docNotes" placeholder="Optional notes / terms shown on the document."></textarea>

      <label>Payment instructions (optional)</label>
      <textarea id="payNotes" placeholder="Optional payment instructions shown on the document."></textarea>

      <div class="btnbar">
        <button class="btn ghost" id="btnSaveNotes" type="button">Save Notes</button>
      </div>
    </div>

    <div class="card">
      <div class="h">
        <h2>Document Preview</h2>
        <span class="sub">This is what will print.</span>
      </div>
      <div id="screenPreview" style="border:1px solid var(--line); border-radius:16px; overflow:hidden;"></div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="view-history" class="stack noprint" style="display:none">
    <div class="card">
      <div class="h">
        <h2>History</h2>
        <span class="sub">Search customers and documents.</span>
      </div>
      <label>Search</label>
      <input id="historySearch" placeholder="Name, email, phone, doc number…" />
    </div>

    <div class="two">
      <div class="card">
        <div class="h">
          <h2>Customers</h2>
          <span class="sub">Tap to load</span>
        </div>
        <div class="list" id="custHistoryList"></div>
      </div>
      <div class="card">
        <div class="h">
          <h2>Documents</h2>
          <span class="sub">Tap to open</span>
        </div>
        <div class="list" id="docHistoryList"></div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="view-settings" class="stack noprint" style="display:none">
    <div class="card">
      <div class="h">
        <h2>Business</h2>
        <span class="sub">Shown at the top of quotes/invoices.</span>
      </div>

      <div class="two">
        <div>
          <label>Business name</label>
          <input id="bizName" placeholder="Your Business LLC" />
        </div>
        <div>
          <label>Phone</label>
          <input id="bizPhone" placeholder="(555) 555-5555" />
        </div>
        <div>
          <label>Email</label>
          <input id="bizEmail" placeholder="you@email.com" />
        </div>
        <div>
          <label>Website (optional)</label>
          <input id="bizWebsite" placeholder="yourwebsite.com" />
        </div>
        <div style="grid-column: 1 / -1">
          <label>Address / License (optional)</label>
          <input id="bizAddr" placeholder="Phoenix, AZ • ROC #123456 • Insured" />
        </div>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="btnSaveBiz" type="button">Save Business</button>
      </div>
    </div>

    <div class="card">
      <div class="h">
        <h2>Backup</h2>
        <span class="sub">Export / import your data.</span>
      </div>
      <div class="btnbar">
        <button class="btn" id="btnExport" type="button">Export JSON</button>
        <label class="btn" style="cursor:pointer">
          Import JSON
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <button class="btn danger" id="btnWipe" type="button">Wipe Data</button>
      </div>
      <div class="sub" id="backupHint" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Print Area -->
  <section id="printArea"></section>
</div>

<!-- Bottom Nav -->
<div class="nav noprint">
  <div class="nav-inner">
    <button class="navbtn active" data-view="docs" type="button">Docs</button>
    <button class="navbtn" data-view="customer" type="button">Customer</button>
    <button class="navbtn" data-view="items" type="button">Items</button>
    <button class="navbtn" data-view="preview" type="button">Preview</button>
    <button class="navbtn" data-view="history" type="button">History</button>
    <button class="navbtn" data-view="settings" type="button">Settings</button>
  </div>
</div>

<div class="toast" id="toast">
  <b id="toastTitle"></b>
  <span id="toastMsg"></span>
</div>

<!-- UPDATED: Full Screen Preview Overlay -->
<div class="previewOverlay noprint" id="previewOverlay">
  <div class="panel">
    <div class="bar">
      <div>
        <b>Preview</b>
        <div class="sub" id="previewOverlaySubtitle">Full screen</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn" id="btnCloseOverlay" type="button">Done</button>
        <button class="btn primary" id="btnPrint2" type="button">Print / Save PDF</button>
      </div>
    </div>
    <div class="content" id="previewOverlayContent"></div>
  </div>
</div>

<script>
(function(){
  /* ========= Storage ========= */
  const LS = {
    customers: "handy_customers_v2",
    documents: "handy_docs_v2",
    counters:  "handy_counters_v2",
    business:  "handy_biz_v2"
  };

  const $ = (id)=>document.getElementById(id);
  const nowISO = ()=>new Date().toISOString();
  const todayISO = ()=>new Date().toISOString().slice(0,10);
  const addDaysISO = (iso, days)=>{
    const d = iso ? new Date(iso+"T00:00:00") : new Date();
    d.setDate(d.getDate()+days);
    return d.toISOString().slice(0,10);
  };
  const fmtUSD = (n)=>(isFinite(n)?n:0).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const uid = (prefix)=> `${prefix}_${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`;

  function loadJSON(key, fallback){
    try{ const r = localStorage.getItem(key); return r?JSON.parse(r):fallback; }catch{ return fallback; }
  }
  function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  let customers = loadJSON(LS.customers, {});
  let documents = loadJSON(LS.documents, {});
  let counters  = loadJSON(LS.counters, { quote: 0, invoice: 0 });
  let business  = loadJSON(LS.business, { name:"Your Business", phone:"", email:"", website:"", addr:"" });

  let activeCustomerId = null;
  let activeDocId = null;

  function persist(){
    saveJSON(LS.customers, customers);
    saveJSON(LS.documents, documents);
    saveJSON(LS.counters, counters);
    saveJSON(LS.business, business);
  }

  /* ========= Toast ========= */
  let toastTimer=null;
  function toast(title, msg){
    $("toastTitle").textContent = title;
    $("toastMsg").textContent = msg || "";
    $("toast").classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>$("toast").classList.remove("show"), 2400);
  }

  /* ========= Document model ========= */
  function ensureDoc(d){
    if(!d.lineItems) d.lineItems = [];
    if(typeof d.sent !== "boolean") d.sent = false;
    if(!("sentAt" in d)) d.sentAt = null;
    if(typeof d.paid !== "boolean") d.paid = false;
    if(!("paidAt" in d)) d.paidAt = null;

    if(!d.discount) d.discount = { type:"none", value:0 };
    if(typeof d.taxRate !== "number") d.taxRate = parseFloat(d.taxRate||"0") || 0;

    if(d.paid && !d.sent){
      d.sent = true;
      d.sentAt = d.sentAt || nowISO();
    }
  }

  function nextNumber(type){
    const yr = new Date().getFullYear();
    counters[type] = (counters[type]||0) + 1;
    const seq = String(counters[type]).padStart(4,"0");
    return (type==="quote") ? `Q-${yr}-${seq}` : `I-${yr}-${seq}`;
  }

  function newDoc(type="quote"){
    const id = uid("doc");
    const issue = todayISO();
    const d2 = type==="quote" ? addDaysISO(issue,14) : addDaysISO(issue,7);

    const doc = {
      id,
      type,
      number: nextNumber(type),
      customerId: activeCustomerId || null,
      issueDate: issue,
      validUntil: type==="quote" ? d2 : null,
      dueDate: type==="invoice" ? d2 : null,
      sent:false, sentAt:null,
      paid:false, paidAt:null,
      lineItems: [],
      taxRate: 0,
      discount: { type:"none", value:0 },
      notes: "",
      payNotes: "",
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    documents[id] = doc;
    activeDocId = id;
    persist();
    toast("New document", `${doc.type.toUpperCase()} ${doc.number}`);
    renderAll();
  }

  function convertToInvoice(){
    const src = documents[activeDocId];
    if(!src){ toast("No document", "Create or load a quote first."); return; }
    ensureDoc(src);
    if(src.type !== "quote"){ toast("Already an invoice", "This document is already an invoice."); return; }

    const id = uid("doc");
    const issue = todayISO();
    const inv = JSON.parse(JSON.stringify(src));

    inv.id = id;
    inv.type = "invoice";
    inv.number = nextNumber("invoice");
    inv.issueDate = issue;
    inv.dueDate = addDaysISO(issue,7);
    inv.validUntil = null;

    inv.sent = false; inv.sentAt = null;
    inv.paid = false; inv.paidAt = null;

    inv.createdAt = Date.now();
    inv.updatedAt = Date.now();

    documents[id] = inv;
    activeDocId = id;
    persist();
    toast("Converted", `Invoice ${inv.number} created`);
    renderAll();
    showView("preview");
  }

  function deleteDoc(){
    const d = documents[activeDocId];
    if(!d){ toast("No document", "Nothing to delete."); return; }
    if(!confirm(`Delete ${d.type.toUpperCase()} ${d.number}?`)) return;
    delete documents[activeDocId];
    activeDocId = null;
    persist();
    toast("Deleted", "Document deleted");
    renderAll();
  }

  /* ========= Totals ========= */
  function totals(doc){
    ensureDoc(doc);
    let billableSubtotal = 0;

    for(const it of doc.lineItems){
      if(it.kind === "labor"){
        billableSubtotal += (parseFloat(it.hours)||0) * (parseFloat(it.rate)||0);
      } else if(it.kind === "flat"){
        billableSubtotal += (parseFloat(it.amount)||0);
      } else if(it.kind === "materials"){
        if(it.billable){
          billableSubtotal += (parseFloat(it.qty)||0) * (parseFloat(it.unitCost)||0);
        } // customer provided has no value, excluded
      }
    }

    const dType = doc.discount?.type || "none";
    const dVal = parseFloat(doc.discount?.value)||0;

    let disc = 0;
    if(dType === "percent") disc = billableSubtotal * (dVal/100);
    if(dType === "flat") disc = dVal;
    disc = Math.min(disc, billableSubtotal);

    const afterDisc = Math.max(billableSubtotal - disc, 0);
    const taxRate = parseFloat(doc.taxRate)||0;
    const tax = afterDisc * (taxRate/100);
    const total = afterDisc + tax;

    return { billableSubtotal, disc, afterDisc, tax, total };
  }

  /* ========= UI helpers ========= */
  function esc(s){
    return String(s??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function setSegActive(segButtons, activeId){
    for(const id of segButtons){
      const el = $(id);
      el.classList.toggle("active", id === activeId);
    }
  }

  function showView(name){
    const views = ["docs","customer","items","preview","history","settings"];
    for(const v of views){
      const el = $("view-"+v);
      el.style.display = (v===name) ? "" : "none";
    }
    document.querySelectorAll(".navbtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.view === name);
    });

    if(name === "preview") renderPreview();
    if(name === "history") renderHistory();
  }

  /* ========= Customers ========= */
  function renderCustomerSelects(){
    const list = Object.values(customers).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    const cs = $("customerSelect");
    cs.innerHTML = "";
    const optNew = document.createElement("option");
    optNew.value = "";
    optNew.textContent = "(New customer)";
    cs.appendChild(optNew);
    for(const c of list){
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name || c.id;
      cs.appendChild(o);
    }
    cs.value = activeCustomerId || "";

    const ds = $("docCustomerSelect");
    ds.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value = "";
    o0.textContent = "(No customer selected)";
    ds.appendChild(o0);
    for(const c of list){
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name || c.id;
      ds.appendChild(o);
    }
    const doc = documents[activeDocId];
    ds.value = doc?.customerId || "";
  }

  function loadCustomerToForm(id){
    const c = customers[id] || {name:"", email:"", phone:"", address:""};
    $("custName").value = c.name || "";
    $("custEmail").value = c.email || "";
    $("custPhone").value = c.phone || "";
    $("custAddress").value = c.address || "";
    $("custMode").textContent = id ? "Editing" : "New";
  }

  function saveCustomer(){
    const name = $("custName").value.trim();
    if(!name){ toast("Missing", "Customer name is required"); return; }
    const email = $("custEmail").value.trim();
    const phone = $("custPhone").value.trim();
    const address = $("custAddress").value.trim();
    const now = Date.now();

    let id = activeCustomerId;
    if(!id){
      id = uid("cust");
      customers[id] = { id, name, email, phone, address, createdAt: now, updatedAt: now };
      activeCustomerId = id;
    } else {
      customers[id] = { ...(customers[id]||{}), id, name, email, phone, address, updatedAt: now };
    }

    const doc = documents[activeDocId];
    if(doc){
      doc.customerId = activeCustomerId;
      doc.updatedAt = now;
    }

    persist();
    toast("Saved", "Customer saved");
    renderAll();
  }

  function deleteCustomer(){
    if(!activeCustomerId){ toast("No customer", "Select a customer first"); return; }
    const c = customers[activeCustomerId];
    if(!confirm(`Delete customer "${c?.name||activeCustomerId}"?`)) return;

    for(const d of Object.values(documents)){
      if(d.customerId === activeCustomerId){
        d.customerId = null;
        d.updatedAt = Date.now();
      }
    }

    delete customers[activeCustomerId];
    activeCustomerId = null;
    persist();
    toast("Deleted", "Customer deleted");
    renderAll();
  }

  /* ========= Document controls ========= */
  function setTypeUI(type){
    setSegActive(["segQuote","segInvoice"], type==="quote" ? "segQuote" : "segInvoice");
    $("paidWrap").style.display = (type==="invoice") ? "" : "none";
    $("date2Label").textContent = (type==="quote") ? "Valid until" : "Due date";
  }

  function saveDocFromUI(){
    const doc = documents[activeDocId];
    if(!doc){ toast("No document", "Create a document first"); return; }
    ensureDoc(doc);

    const type = doc.type;
    doc.issueDate = $("issueDate").value || todayISO();

    const d2 = $("date2").value || (type==="quote" ? addDaysISO(doc.issueDate,14) : addDaysISO(doc.issueDate,7));
    if(type==="quote"){ doc.validUntil = d2; doc.dueDate = null; }
    else { doc.dueDate = d2; doc.validUntil = null; }

    doc.customerId = $("docCustomerSelect").value || null;

    const sent = $("sentState").value === "1";
    const paid = $("paidState").value === "1";

    if(sent !== doc.sent){
      doc.sent = sent;
      doc.sentAt = sent ? (doc.sentAt || nowISO()) : null;
      if(!sent){
        doc.paid = false;
        doc.paidAt = null;
      }
    }

    if(doc.type === "invoice"){
      if(paid !== doc.paid){
        doc.paid = paid;
        doc.paidAt = paid ? (doc.paidAt || nowISO()) : null;
        if(paid && !doc.sent){
          doc.sent = true;
          doc.sentAt = doc.sentAt || nowISO();
        }
      }
    } else {
      doc.paid = false;
      doc.paidAt = null;
    }

    doc.updatedAt = Date.now();
    persist();
    toast("Saved", "Document updated");
    renderAll();
  }

  function renderDocHeader(){
    const doc = documents[activeDocId] || null;

    if(!doc){
      $("pillLine1").textContent = "No document";
      $("pillLine2").textContent = "";
      $("docNumber").value = "";
      $("issueDate").value = todayISO();
      $("date2").value = addDaysISO(todayISO(),14);
      $("sentState").value = "0";
      $("paidState").value = "0";
      $("sentAtLine").textContent = "";
      $("paidAtLine").textContent = "";
      $("docChips").innerHTML = "";
      $("topSubtitle").textContent = "Quotes & Invoices • Offline";
      return;
    }

    ensureDoc(doc);
    const cust = customers[doc.customerId] || null;

    // UPDATED: two-line pill
    $("pillLine1").textContent = `${doc.type.toUpperCase()} ${doc.number}`;
    $("pillLine2").textContent = cust?.name ? cust.name : "";

    $("topSubtitle").textContent = `${doc.type.toUpperCase()} ${doc.number}`;

    $("docNumber").value = doc.number;
    $("issueDate").value = doc.issueDate || todayISO();
    $("date2").value = (doc.type==="quote" ? (doc.validUntil||addDaysISO(doc.issueDate||todayISO(),14))
                                          : (doc.dueDate||addDaysISO(doc.issueDate||todayISO(),7)));

    setTypeUI(doc.type);

    $("sentState").value = doc.sent ? "1" : "0";
    $("paidState").value = doc.paid ? "1" : "0";
    $("sentAtLine").textContent = doc.sentAt ? `Sent: ${new Date(doc.sentAt).toLocaleString()}` : "";
    $("paidAtLine").textContent = doc.paidAt ? `Paid: ${new Date(doc.paidAt).toLocaleString()}` : "";

    const chips = [];
    chips.push(`<span class="chip blue">${doc.type.toUpperCase()}</span>`);
    chips.push(doc.sent ? `<span class="chip green">SENT</span>` : `<span class="chip red">NOT SENT</span>`);
    if(doc.type==="invoice"){
      chips.push(doc.paid ? `<span class="chip green">PAID</span>` : `<span class="chip orange">UNPAID</span>`);
    }
    $("docChips").innerHTML = chips.join("");

    $("docHint").textContent = (doc.type==="quote")
      ? "Build your quote. When approved, convert it to an invoice."
      : "Invoice ready. Mark Sent/Paid as it progresses.";
  }

  /* ========= Items rendering ========= */
  function itemSummary(it){
    if(it.kind === "labor"){
      const h = parseFloat(it.hours)||0;
      const r = parseFloat(it.rate)||0;
      return `Labor • ${h} hrs @ ${fmtUSD(r)}/hr`;
    }
    if(it.kind === "flat"){
      const a = parseFloat(it.amount)||0;
      return `Flat • ${fmtUSD(a)}`;
    }
    if(it.kind === "materials"){
      const qty = parseFloat(it.qty)||0;
      const unit = it.unit || "ea";
      if(it.billable){
        const uc = parseFloat(it.unitCost)||0;
        return `Materials • ${qty} ${unit} @ ${fmtUSD(uc)} each`;
      }
      return `Materials • ${qty} ${unit} • Customer provided (no charge)`;
    }
    return "";
  }

  function itemLineTotal(it){
    if(it.kind==="labor") return (parseFloat(it.hours)||0) * (parseFloat(it.rate)||0);
    if(it.kind==="flat") return (parseFloat(it.amount)||0);
    if(it.kind==="materials"){
      if(!it.billable) return 0;
      return (parseFloat(it.qty)||0) * (parseFloat(it.unitCost)||0);
    }
    return 0;
  }

  function renderItems(){
    const doc = documents[activeDocId];
    const list = $("itemsList");
    list.innerHTML = "";

    if(!doc){
      list.innerHTML = `<div class="sub">Create a document first.</div>`;
      return;
    }
    ensureDoc(doc);

    if(doc.lineItems.length === 0){
      list.innerHTML = `<div class="sub">No items yet. Add your first item below.</div>`;
      return;
    }

    doc.lineItems.forEach((it, idx)=>{
      const lineTotal = itemLineTotal(it);
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="item-head">
          <div class="item-title">
            <b>${esc(it.desc || "Item")}</b>
            <span>${esc(itemSummary(it))}</span>
          </div>
          <div class="item-actions">
            <button class="mini-btn" data-act="dup" data-idx="${idx}" type="button">Duplicate</button>
            <button class="mini-btn danger" data-act="del" data-idx="${idx}" type="button">Remove</button>
          </div>
        </div>
        <div class="kv">
          <div class="line"><span>Line total</span><b>${(it.kind==="materials" && !it.billable) ? "—" : fmtUSD(lineTotal)}</b></div>
        </div>
      `;
      list.appendChild(el);
    });

    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.dataset.act;
        const idx = parseInt(btn.dataset.idx,10);
        const d = documents[activeDocId];
        if(!d) return;
        if(act==="del"){
          d.lineItems.splice(idx,1);
          d.updatedAt = Date.now();
          persist();
          toast("Removed", "Item removed");
          renderAll();
        }
        if(act==="dup"){
          const src = d.lineItems[idx];
          d.lineItems.splice(idx+1, 0, JSON.parse(JSON.stringify(src)));
          d.updatedAt = Date.now();
          persist();
          toast("Duplicated", "Item duplicated");
          renderAll();
        }
      });
    });
  }

  /* ========= Add Item Wizard ========= */
  let addKind = "labor";          // labor|materials|flat
  let matMode = "billable";       // billable|customer

  function setAddKind(kind){
    addKind = kind;
    setSegActive(["segItemLabor","segItemMaterials","segItemFlat"],
      kind==="labor" ? "segItemLabor" : kind==="materials" ? "segItemMaterials" : "segItemFlat"
    );

    $("branchLabor").style.display = (kind==="labor") ? "" : "none";
    $("branchMaterials").style.display = (kind==="materials") ? "" : "none";
    $("branchFlat").style.display = (kind==="flat") ? "" : "none";
  }

  function setMatMode(mode){
    matMode = mode;
    setSegActive(["segMatBillable","segMatCustomer"], mode==="billable" ? "segMatBillable" : "segMatCustomer");
    $("matBillableFields").style.display = (mode==="billable") ? "" : "none";
    $("matCustomerNote").style.display = (mode==="customer") ? "" : "none";
  }

  function resetAddForm(){
    $("addDesc").value = "";
    $("laborHours").value = "1";
    $("laborRate").value = "";
    $("laborRateCustomWrap").style.display = "none";
    $("laborRateCustom").value = "";

    setMatMode("billable");
    $("matQty").value = "1";
    $("matQtyCustomWrap").style.display = "none";
    $("matQtyCustom").value = "";
    $("matUnit").value = "ea";
    $("matUnitCustomWrap").style.display = "none";
    $("matUnitCustom").value = "";
    $("matUnitCost").value = "";
    $("matCostCustomWrap").style.display = "none";
    $("matCostCustom").value = "";

    $("flatAmount").value = "";
    $("flatCustomWrap").style.display = "none";
    $("flatCustom").value = "";
  }

  function addItem(){
    const doc = documents[activeDocId];
    if(!doc){ toast("No document", "Create a document first"); return; }
    ensureDoc(doc);

    const desc = $("addDesc").value.trim();
    if(!desc){ toast("Missing", "Add a short description"); return; }

    if(addKind === "labor"){
      const hours = parseFloat($("laborHours").value) || 0;
      let rateVal = $("laborRate").value;
      let rate = 0;
      if(rateVal === "custom"){
        rate = parseFloat($("laborRateCustom").value || "0") || 0;
      } else {
        rate = parseFloat(rateVal || "0") || 0;
      }
      if(rate <= 0){ toast("Missing", "Choose an hourly rate"); return; }

      doc.lineItems.push({ kind:"labor", desc, hours, rate });

    } else if(addKind === "materials"){
      let qtyRaw = $("matQty").value;
      let qty = 1;
      if(qtyRaw === "custom"){
        qty = parseFloat($("matQtyCustom").value || "0") || 0;
      } else {
        qty = parseFloat(qtyRaw || "0") || 0;
      }
      if(qty <= 0){ toast("Missing", "Quantity must be > 0"); return; }

      let unit = $("matUnit").value;
      if(unit === "custom") unit = ($("matUnitCustom").value || "").trim() || "ea";

      if(matMode === "customer"){
        doc.lineItems.push({ kind:"materials", desc, qty, unit, billable:false });
      } else {
        let costVal = $("matUnitCost").value;
        let unitCost = 0;
        if(costVal === "custom"){
          unitCost = parseFloat($("matCostCustom").value || "0") || 0;
        } else {
          unitCost = parseFloat(costVal || "0") || 0;
        }
        if(unitCost <= 0){ toast("Missing", "Choose a unit cost"); return; }
        doc.lineItems.push({ kind:"materials", desc, qty, unit, billable:true, unitCost });
      }

    } else if(addKind === "flat"){
      let v = $("flatAmount").value;
      let amt = 0;
      if(v === "custom"){
        amt = parseFloat($("flatCustom").value || "0") || 0;
      } else {
        amt = parseFloat(v || "0") || 0;
      }
      if(amt <= 0){ toast("Missing", "Choose an amount"); return; }
      doc.lineItems.push({ kind:"flat", desc, amount: amt });
    }

    doc.updatedAt = Date.now();
    persist();
    toast("Added", "Item added");
    renderAll();
    resetAddForm();
  }

  /* ========= Pricing ========= */
  function readTaxRate(){
    const v = $("taxRate").value;
    if(v === "custom"){
      return parseFloat($("taxCustom").value || "0") || 0;
    }
    return parseFloat(v || "0") || 0;
  }

  function readDiscount(){
    const type = $("discountType").value;
    const pv = $("discountValuePreset").value;
    let val = 0;
    if(pv === "custom"){
      val = parseFloat($("discountCustom").value || "0") || 0;
    } else {
      val = parseFloat(pv || "0") || 0;
    }
    return { type, value: val };
  }

  function savePricing(){
    const doc = documents[activeDocId];
    if(!doc){ toast("No document", "Create a document first"); return; }
    ensureDoc(doc);

    doc.taxRate = readTaxRate();
    doc.discount = readDiscount();
    doc.updatedAt = Date.now();
    persist();
    toast("Saved", "Pricing updated");
    renderAll();
  }

  function renderPricingUI(){
    const doc = documents[activeDocId];
    if(!doc) return;
    ensureDoc(doc);

    const tr = parseFloat(doc.taxRate || 0);
    const presets = ["0","2","4","5.6","8.6"];
    if(presets.includes(String(tr))){
      $("taxRate").value = String(tr);
      $("taxCustomWrap").style.display = "none";
      $("taxCustom").value = "";
    } else {
      $("taxRate").value = "custom";
      $("taxCustomWrap").style.display = "";
      $("taxCustom").value = String(tr);
    }

    $("discountType").value = doc.discount?.type || "none";
    const dv = parseFloat(doc.discount?.value || 0);
    const dp = ["0","5","10","15","20"];
    if(dp.includes(String(dv))){
      $("discountValuePreset").value = String(dv);
      $("discountCustomWrap").style.display = "none";
      $("discountCustom").value = "";
    } else {
      $("discountValuePreset").value = "custom";
      $("discountCustomWrap").style.display = "";
      $("discountCustom").value = String(dv);
    }
  }

  /* ========= Totals box ========= */
  function renderTotalsBox(){
    const doc = documents[activeDocId];
    const box = $("totalsBox");
    if(!doc){
      box.innerHTML = `<div class="sub">Create a document first.</div>`;
      return;
    }
    const t = totals(doc);

    const d = doc.discount || {type:"none", value:0};
    const discLabel = d.type==="percent" ? `Discount (${d.value || 0}%)` : "Discount";

    box.innerHTML = `
      <div class="line"><span>Billable subtotal</span><b>${fmtUSD(t.billableSubtotal)}</b></div>
      <div class="line"><span>${discLabel}</span><b>-${fmtUSD(t.disc)}</b></div>
      <div class="line"><span>After discount</span><b>${fmtUSD(t.afterDisc)}</b></div>
      <div class="line"><span>Tax (${parseFloat(doc.taxRate||0)}%)</span><b>${fmtUSD(t.tax)}</b></div>
      <div class="line grand"><span>Total</span><b>${fmtUSD(t.total)}</b></div>
    `;
  }

  /* ========= Preview / Print ========= */
  function renderPreview(){
    const doc = documents[activeDocId];
    if(!doc){
      $("screenPreview").innerHTML = `<div style="padding:12px" class="sub">Create a document first.</div>`;
      return;
    }
    ensureDoc(doc);

    const cust = customers[doc.customerId] || null;
    const t = totals(doc);

    const html = buildPrintHTML(doc, cust, t);
    $("screenPreview").innerHTML = html;
    $("printArea").innerHTML = html;

    $("docNotes").value = doc.notes || "";
    $("payNotes").value = doc.payNotes || "";
  }

  function buildPrintHTML(doc, cust, t){
    const typeTitle = doc.type.toUpperCase();
    const date2Title = (doc.type==="quote") ? "Valid Until" : "Due Date";
    const date2Value = (doc.type==="quote") ? (doc.validUntil||"") : (doc.dueDate||"");

    const sentLine = doc.sent ? `YES${doc.sentAt ? ` (${new Date(doc.sentAt).toLocaleString()})` : ""}` : "NO";
    const paidLine = (doc.type==="invoice")
      ? (doc.paid ? `YES${doc.paidAt ? ` (${new Date(doc.paidAt).toLocaleString()})` : ""}` : "NO")
      : "—";

    const disc = doc.discount || {type:"none", value:0};
    const discLabel = disc.type==="percent" ? `Discount (${disc.value||0}%)` : "Discount";

    const rows = (doc.lineItems||[]).map((it)=>{
      if(it.kind==="labor"){
        const hours = parseFloat(it.hours)||0;
        const rate = parseFloat(it.rate)||0;
        const total = hours*rate;
        return `
          <tr>
            <td>${esc(it.desc||"")}</td>
            <td class="r">${hours} hr</td>
            <td class="r">${fmtUSD(rate)}/hr</td>
            <td class="r">${fmtUSD(total)}</td>
          </tr>
        `;
      }
      if(it.kind==="flat"){
        const amt = parseFloat(it.amount)||0;
        return `
          <tr>
            <td>${esc(it.desc||"")}</td>
            <td class="r">1</td>
            <td class="r">${fmtUSD(amt)}</td>
            <td class="r">${fmtUSD(amt)}</td>
          </tr>
        `;
      }
      if(it.kind==="materials"){
        const qty = parseFloat(it.qty)||0;
        const unit = it.unit || "ea";
        if(!it.billable){
          return `
            <tr>
              <td>${esc(it.desc||"")} <span style="color:#666"> (Customer provided)</span></td>
              <td class="r">${qty} ${esc(unit)}</td>
              <td class="r">—</td>
              <td class="r">—</td>
            </tr>
          `;
        }
        const uc = parseFloat(it.unitCost)||0;
        const total = qty*uc;
        return `
          <tr>
            <td>${esc(it.desc||"")}</td>
            <td class="r">${qty} ${esc(unit)}</td>
            <td class="r">${fmtUSD(uc)}</td>
            <td class="r">${fmtUSD(total)}</td>
          </tr>
        `;
      }
      return "";
    }).join("");

    return `
      <div class="doc">
        <div class="head">
          <div class="biz">
            <h1>${esc(business.name||"Your Business")}</h1>
            <div class="mut">
              ${esc([business.addr, business.phone, business.email, business.website].filter(Boolean).join(" • "))}
            </div>
          </div>
          <div class="box">
            <b>${typeTitle}</b>
            <div class="kvp">
              Number: ${esc(doc.number||"")}<br>
              Issue Date: ${esc(doc.issueDate||"")}<br>
              ${esc(date2Title)}: ${esc(date2Value)}<br>
              Sent: ${esc(sentLine)}<br>
              Paid: ${esc(paidLine)}
            </div>
          </div>
        </div>

        <div class="twocol">
          <div class="box">
            <b>Bill To</b>
            <div class="kvp">
              ${esc(cust?.name || "(No customer selected)")}<br>
              ${esc(cust?.email || "")}<br>
              ${esc(cust?.phone || "")}<br>
              ${esc(cust?.address || "")}
            </div>
          </div>
          <div class="box">
            <b>Summary</b>
            <div class="kvp">
              Billable Subtotal: ${fmtUSD(t.billableSubtotal)}<br>
              ${esc(discLabel)}: -${fmtUSD(t.disc)}<br>
              Tax (${parseFloat(doc.taxRate||0)}%): ${fmtUSD(t.tax)}<br>
              <span style="font-weight:700">Total: ${fmtUSD(t.total)}</span>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th class="r">Qty</th>
              <th class="r">Rate</th>
              <th class="r">Line Total</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="4">No items</td></tr>`}
          </tbody>
        </table>

        <div class="notes">
          <div class="sectionTitle">Notes / Terms</div>
          <div>${esc((doc.notes||"").trim() || "(none)")}</div>
          <div style="height:10px"></div>
          <div class="sectionTitle">Payment</div>
          <div>${esc((doc.payNotes||"").trim() || "(none)")}</div>
        </div>

        <div class="foot">
          <div></div>
          <div>${new Date().toLocaleString()}</div>
        </div>
      </div>
    `;
  }

  function saveNotes(){
    const doc = documents[activeDocId];
    if(!doc){ toast("No document", "Create a document first"); return; }
    ensureDoc(doc);
    doc.notes = $("docNotes").value || "";
    doc.payNotes = $("payNotes").value || "";
    doc.updatedAt = Date.now();
    persist();
    toast("Saved", "Notes updated");
    renderAll();
  }

  function emailDraft(){
    const doc = documents[activeDocId];
    if(!doc){ toast("No document", "Create a document first"); return; }
    ensureDoc(doc);
    const cust = customers[doc.customerId] || null;
    const to = (cust?.email || "").trim();
    if(!to){ toast("Missing email", "Add the customer email first"); showView("customer"); return; }

    const t = totals(doc);
    const subject = `${doc.type==="quote" ? "Quote" : "Invoice"} ${doc.number} - ${cust?.name || "Customer"}`;
    const date2Line = doc.type==="quote"
      ? `Valid until: ${doc.validUntil || ""}`
      : `Due date: ${doc.dueDate || ""}`;

    const body =
`Hi ${cust?.name || ""},

Attached is your ${doc.type} (${doc.number}).
${date2Line}
Total: ${fmtUSD(t.total)}


Thanks,
${business.name || "Your Business"}`;

    const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
  }

  /* ========= History ========= */
  function sortedDocs(){
    return Object.values(documents).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  }

  function renderHistory(){
    const q = ($("historySearch").value || "").toLowerCase().trim();
    const custList = $("custHistoryList");
    const docList = $("docHistoryList");
    custList.innerHTML = "";
    docList.innerHTML = "";

    const custArr = Object.values(customers).sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .filter(c=>{
        if(!q) return true;
        return [c.name,c.email,c.phone,c.address].some(v=>(v||"").toLowerCase().includes(q));
      });

    if(custArr.length===0){
      custList.innerHTML = `<div class="sub">No customers found.</div>`;
    } else {
      custArr.forEach(c=>{
        const row = document.createElement("div");
        row.className = "listrow";
        row.innerHTML = `
          <div class="meta">
            <b>${esc(c.name||"(unnamed)")}</b>
            <span>${esc([c.email,c.phone].filter(Boolean).join(" • "))}</span>
            <span>${esc(c.address||"")}</span>
          </div>
          <div>
            <button class="btn primary" data-load-cust="${c.id}" type="button">Load</button>
          </div>
        `;
        custList.appendChild(row);
      });
    }

    const docs = sortedDocs().filter(d=>{
      const cust = customers[d.customerId] || null;
      if(!q) return true;
      return [d.number,d.type,cust?.name,cust?.email,cust?.phone].some(v=>(v||"").toLowerCase().includes(q));
    });

    if(docs.length===0){
      docList.innerHTML = `<div class="sub">No documents found.</div>`;
    } else {
      docs.forEach(d=>{
        ensureDoc(d);
        const cust = customers[d.customerId] || null;
        const t = totals(d);

        const chips = [];
        chips.push(`<span class="chip blue">${d.type.toUpperCase()}</span>`);
        chips.push(d.sent ? `<span class="chip green">SENT</span>` : `<span class="chip red">NOT SENT</span>`);
        if(d.type==="invoice"){
          chips.push(d.paid ? `<span class="chip green">PAID</span>` : `<span class="chip orange">UNPAID</span>`);
        }

        const row = document.createElement("div");
        row.className = "listrow";
        row.innerHTML = `
          <div class="meta">
            <b>${esc(d.number)} • ${esc(cust?.name || "(no customer)")}</b>
            <span>${esc(d.issueDate || "")} • Total ${fmtUSD(t.total)}</span>
            <span>${chips.join(" ")}</span>
          </div>
          <div>
            <button class="btn primary" data-load-doc="${d.id}" type="button">Open</button>
          </div>
        `;
        docList.appendChild(row);
      });
    }

    document.querySelectorAll("[data-load-cust]").forEach(b=>{
      b.onclick = ()=>{
        activeCustomerId = b.dataset.loadCust;
        loadCustomerToForm(activeCustomerId);
        renderAll();
        showView("customer");
        toast("Loaded", "Customer loaded");
      };
    });

    document.querySelectorAll("[data-load-doc]").forEach(b=>{
      b.onclick = ()=>{
        activeDocId = b.dataset.loadDoc;
        const d = documents[activeDocId];
        activeCustomerId = d?.customerId || null;
        renderAll();
        showView("docs");
        toast("Loaded", "Document opened");
      };
    });
  }

  /* ========= Settings / Backup ========= */
  function renderBusiness(){
    $("bizName").value = business.name || "";
    $("bizPhone").value = business.phone || "";
    $("bizEmail").value = business.email || "";
    $("bizWebsite").value = business.website || "";
    $("bizAddr").value = business.addr || "";
  }

  function saveBusiness(){
    business = {
      name: ($("bizName").value || "").trim() || "Your Business",
      phone: ($("bizPhone").value || "").trim(),
      email: ($("bizEmail").value || "").trim(),
      website: ($("bizWebsite").value || "").trim(),
      addr: ($("bizAddr").value || "").trim()
    };
    persist();
    toast("Saved", "Business saved");
    renderAll();
  }

  function exportJSON(){
    const payload = {
      version: 2,
      exportedAt: nowISO(),
      customers, documents, counters, business
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `handy_backup_${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
    $("backupHint").textContent = "Exported. Save this to Files / iCloud / Drive.";
    toast("Exported", "Backup downloaded");
  }

  function importJSON(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        customers = data.customers || {};
        documents = data.documents || {};
        counters  = data.counters  || { quote:0, invoice:0 };
        business  = data.business  || business;

        const ds = sortedDocs();
        activeDocId = ds[0]?.id || null;
        activeCustomerId = activeDocId ? (documents[activeDocId]?.customerId || null) : null;

        persist();
        $("backupHint").textContent = "Imported successfully.";
        toast("Imported", "Backup imported");
        renderAll();
      }catch{
        toast("Import failed", "That file doesn't look like a valid backup");
      }
    };
    fr.readAsText(file);
  }

  function wipeAll(){
    if(!confirm("Wipe ALL data from this browser? This cannot be undone.")) return;
    localStorage.removeItem(LS.customers);
    localStorage.removeItem(LS.documents);
    localStorage.removeItem(LS.counters);
    localStorage.removeItem(LS.business);

    customers = {};
    documents = {};
    counters = { quote:0, invoice:0 };
    business = { name:"Your Business", phone:"", email:"", website:"", addr:"" };
    activeCustomerId = null;
    activeDocId = null;

    toast("Wiped", "All local data cleared");
    renderAll();
  }

  /* ========= Render everything ========= */
  function renderAll(){
    if(activeDocId && !documents[activeDocId]) activeDocId = null;
    if(!activeDocId){
      const ds = sortedDocs();
      if(ds[0]) activeDocId = ds[0].id;
    }
    if(!activeDocId && Object.keys(documents).length === 0){
      newDoc("quote");
      return;
    }

    const doc = documents[activeDocId];
    if(doc){
      ensureDoc(doc);
      activeCustomerId = doc.customerId || activeCustomerId;
    }

    renderCustomerSelects();
    renderDocHeader();
    renderItems();
    renderTotalsBox();
    renderBusiness();
    renderPricingUI();
    renderPreview();
  }

  /* ========= Wire Events ========= */
  function wire(){
    // Bottom nav
    document.querySelectorAll(".navbtn").forEach(b=>{
      b.onclick = ()=> showView(b.dataset.view);
    });

    // Docs shortcuts
    $("btnGoItems").onclick = ()=> showView("items");
    $("btnGoPreview").onclick = ()=> showView("preview");

    // Document type seg
    $("segQuote").onclick = ()=>{
      const doc = documents[activeDocId]; if(!doc) return;
      if(doc.type === "quote") return;
      doc.type = "quote";
      doc.validUntil = doc.validUntil || addDaysISO(doc.issueDate || todayISO(), 14);
      doc.dueDate = null;
      doc.paid = false; doc.paidAt = null;
      doc.updatedAt = Date.now();
      persist();
      renderAll();
    };
    $("segInvoice").onclick = ()=>{
      const doc = documents[activeDocId]; if(!doc) return;
      if(doc.type === "invoice") return;
      doc.type = "invoice";
      doc.dueDate = doc.dueDate || addDaysISO(doc.issueDate || todayISO(), 7);
      doc.validUntil = null;
      doc.updatedAt = Date.now();
      persist();
      renderAll();
    };

    $("issueDate").addEventListener("change", saveDocFromUI);
    $("date2").addEventListener("change", saveDocFromUI);
    $("docCustomerSelect").addEventListener("change", saveDocFromUI);
    $("sentState").addEventListener("change", saveDocFromUI);
    $("paidState").addEventListener("change", saveDocFromUI);

    $("btnNewQuote").onclick = ()=> newDoc("quote");
    $("btnSaveDoc").onclick = saveDocFromUI;
    $("btnConvert").onclick = convertToInvoice;
    $("btnConvert2").onclick = convertToInvoice;
    $("btnDeleteDoc").onclick = deleteDoc;

    // Customer tab
    $("customerSelect").addEventListener("change", ()=>{
      const id = $("customerSelect").value || null;
      activeCustomerId = id;
      loadCustomerToForm(id);
    });
    $("btnSaveCustomer").onclick = saveCustomer;
    $("btnNewCustomer").onclick = ()=>{
      activeCustomerId = null;
      $("customerSelect").value = "";
      loadCustomerToForm(null);
      toast("New", "Enter details then Save");
    };
    $("btnDeleteCustomer").onclick = deleteCustomer;

    // Items wizard segs
    $("segItemLabor").onclick = ()=> setAddKind("labor");
    $("segItemMaterials").onclick = ()=> setAddKind("materials");
    $("segItemFlat").onclick = ()=> setAddKind("flat");

    $("segMatBillable").onclick = ()=> setMatMode("billable");
    $("segMatCustomer").onclick = ()=> setMatMode("customer");

    // Custom dropdown revealers
    $("laborRate").addEventListener("change", ()=>{
      $("laborRateCustomWrap").style.display = ($("laborRate").value==="custom") ? "" : "none";
    });

    $("matQty").addEventListener("change", ()=>{
      $("matQtyCustomWrap").style.display = ($("matQty").value==="custom") ? "" : "none";
    });
    $("matUnit").addEventListener("change", ()=>{
      $("matUnitCustomWrap").style.display = ($("matUnit").value==="custom") ? "" : "none";
    });
    $("matUnitCost").addEventListener("change", ()=>{
      $("matCostCustomWrap").style.display = ($("matUnitCost").value==="custom") ? "" : "none";
    });

    $("flatAmount").addEventListener("change", ()=>{
      $("flatCustomWrap").style.display = ($("flatAmount").value==="custom") ? "" : "none";
    });

    // Pricing custom revealers
    $("taxRate").addEventListener("change", ()=>{
      $("taxCustomWrap").style.display = ($("taxRate").value==="custom") ? "" : "none";
    });
    $("discountValuePreset").addEventListener("change", ()=>{
      $("discountCustomWrap").style.display = ($("discountValuePreset").value==="custom") ? "" : "none";
    });

    $("btnAddItem").onclick = addItem;
    $("btnClearAdd").onclick = resetAddForm;

    $("btnSavePricing").onclick = savePricing;
    $("btnBackHome").onclick = ()=> showView("docs");

    // Preview
    $("btnPrint").onclick = ()=> { renderPreview(); window.print(); };
    $("btnEmail").onclick = emailDraft;
    $("btnSaveNotes").onclick = saveNotes;

    // UPDATED: Full Screen Preview overlay
    $("btnFullPreview").onclick = ()=>{
      renderPreview();
      $("previewOverlayContent").innerHTML = $("screenPreview").innerHTML;
      $("previewOverlay").classList.add("show");
    };
    $("btnCloseOverlay").onclick = ()=> $("previewOverlay").classList.remove("show");
    $("btnPrint2").onclick = ()=> { renderPreview(); window.print(); };

    // History
    $("historySearch").addEventListener("input", renderHistory, {passive:true});

    // Settings
    $("btnSaveBiz").onclick = saveBusiness;
    $("btnExport").onclick = exportJSON;
    $("importFile").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importJSON(f);
      e.target.value = "";
    });
    $("btnWipe").onclick = wipeAll;
  }

  /* ========= Boot ========= */
  wire();

  // init wizard defaults
  setAddKind("labor");
  setMatMode("billable");
  resetAddForm();

  // load first customer if any
  const custArr = Object.values(customers);
  if(custArr[0] && !activeCustomerId) activeCustomerId = custArr[0].id;

  if(Object.keys(documents).length === 0){
    persist();
    newDoc("quote");
  } else {
    renderAll();
  }
})();
</script>

</body>
</html>
